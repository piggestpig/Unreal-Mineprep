# Unreal-MCprep

[**中文**](./README.md) | [**English**](./README_EN.md)

✨这是一个正在开发中的UE5插件，继承了 [Blender MCprep](https://theduckcow.com/dev/blender/mcprep/) 的实用功能，并加入一些新的资产，为制作MC动画带来便利


<img src="/Readme素材/插件展示.png" alt="示例图片" width="520" height="720">

> 目前还没写使用教程 •ࡇ• —— 在v1.0正式发布前，插件主要供内部使用，不考虑兼容性和潜在的 ~~bug~~ 特性。需要安装[TApython](https://github.com/cgerchenhp/UE_TAPython_Plugin_Release) 和 [Easy File Dialog](https://www.unrealengine.com/marketplace/en-US/product/easy-file-dialog) 作为前置插件。

## 版本更新

#### 24w22a
- 本周没有更新，因为我们正在全力制作新的动画视频《史蒂夫之梦》！过几天就能发布啦，祝MC15周年生日快乐（托更了好久hh）

#### 24w21a
- 新增`摇臂摄像机`，预先把电影摄像机绑定到摇臂上，拖入场景即可使用。开启“希区柯克变焦”功能后，摄像机将自动追踪摇臂底座，根据摇臂长度缩放焦距。
> 和单独的摄像机相比，电影摄像机组件缺少追踪模块，因此用蓝图实现了类似功能。遗憾的是和追踪相关的关键帧动画不会在视图中更新，需要进入游戏模式或者渲染才能看到。
- 优化了传送门材质，可以调整纹理和色相，增加了传送门的整体缩放变量
#### 24w20a
- 新增`曲线引导粒子`，由样条线和粒子系统组成，粒子会沿着曲线运动。拖放到场景中之后，选中一个控制点并按住Alt移动，即可挤出新的控制点。
- 修改了所有粒子系统，开放材质或网格体接口，现在可以在细节面板里编辑这些参数了。
- 新增表情动画蓝图，目前处于测试阶段，附带了两个表情。直接把动画蓝图拖放到场景中，在两个轨道中添加身体和表情的动画，然后右键把表情的插槽名称改为“f”，即可分离控制。
- Nvidia宣布将在一个月内更新DLSS插件！这意味这我们可以迁移到UE5.4了，Unreal MCprep 0.3正式版即将推出~

#### 24w19a
- 新增`Demo`分支，存放打包的exe文件，并发布到release里。Git LFS传大文件有好多坑啊啊啊，我最后选择了分卷压缩(doge
- 优化了飞行模式的手感，现在转向回正后不会漂移，按"\\"可以反转鼠标Y轴
- 调整了所有游戏模式的摄像机光圈，可以在更大范围内设置景深了
- 优化了可交互3D水面的渲染，减少颗粒感
- 修改了MC_FaceX和MC_Slim_FaceX的脸部骨骼，为接下来的高级表情控制功能做准备

#### 0.3-pre1
- 第一个预览版本，进行了大量优化并修复了不少bug！稍后将上传打包的exe文件，供没有虚幻引擎的用户体验插件。以下是新功能
- **自发光**  
  `对象`：视口选中项/资产文件夹  
  `效果`：使选中的材质发光，可以分别控制照亮场景的强度和自身亮度  
  `可选项`：照明强度，自身亮度
- **灯光排除**  
  `对象`：视口选中项  
  `效果`：批量分配选中对象的灯光组。只有同一组的灯光才能照亮同一组的物体。默认灯光组是1  
  `可选项`：灯光组 [1，2，3]
- **LOD&Nanite**  
  `对象`：视口选中项/资产文件夹  
  `效果`：开启对应选项后，可提高网格体距离场分辨率至2倍（有利于GPU碰撞检测），开启Nanite并将回退目标的三角形百分比设置为100%（保持原先碰撞箱）  
  `可选项`：2x增强网格体距离场，启用Nanite
> 不清楚这是什么功能？那就最好不要动它哦。MC的Distant Horizon模组特别棒，我也试了试UE5的Nanite优化 —— 虽然帧率显著提升，但方块变成多边形了，一言难尽。2x增强网格体距离场会逐步加重负担，导致帧率下降，建议不要给整个场景使用，应该搭建小的辅助碰撞模型。哦对了，这俩玩意儿加载时间特别长，一不小心还会闪退TAT
- 改进了自定义附魔的实现方法，现在可以在物体面板看到附魔组件了
- 大改视频渲染模块：虚幻引擎默认的ffmpeg编码模式是concat，会导致重复帧和卡顿，拖慢编码速度。现在采用默认的input，极大加快N卡处理png序列帧的速度，视频也变流畅了！
  - 两个mp4渲染配置文件的默认硬件选项从Intel GPU改为Nvidia GPU
  - 插件面板增加了帧率和视频名称的选项
  - 新增以下两个渲染预设，需要开启UE自带的*Apple Prores Media* 插件，无需插件的初始化功能。这个格式编解码速度快，但windows自带播放器是不认的，而且体积很大。
  - `Prores_2K_mov（UE内置插件）`使用2560x1440分辨率，直接输出Prores422LT编码的mov视频，无需渲染结束后的等待。
  - `Prores4444_2K_透明mov（内置插件）`使用2560x1440分辨率，直接输出Prores4444编码的mov视频，还能包含Alpha通道，生成透明免抠视频。    
- 更新了飞行模式，手感大大提升。现在按鼠标左/右/中键都可以急刹，并且效果会叠加。按鼠标侧键可以加速俯仰。我们收集了许多内测建议，将陆陆续续改进。
- 准备场景增加了“启用碰撞”选项
- 更换材质能自动处理动画贴图了
- 新增了UE“建筑可视化”示例里的高质量水材质
- 优化了传送门和落叶粒子。“VFX传送门”可以使用立方体渲染目标的全景贴图，保持高性能的同时带来透视效果，目前还不能传送。
- 新增`可交互2D水面`，`可交互3D水池`，`粒子自碰撞`，都是使用Niagara GPU的高性能粒子系统。
- 新增`场景初始化`蓝图，拖放到场景中设置画质和最高帧率
- 正在制作一个示例文件，展示Unreal MCprep的各种功能，打包后供没有虚幻引擎的用户体验。

#### 24w17b
- 新增了`第三人称运动匹配模式`
  - 可以像MC一样用WASD移动角色、shift潜行、ctrl加速、空格跳跃等等。
  - 角色具有运动匹配功能，会自动从动画库中挑选合适的动画播放
  - 目前从Mixamo中下载了几个动作，包含前后左右的行走和跑步，仅供测试使用。再过几个月，UE5.4会发布一个官方示例文件，里面包含上百个高质量动画。我们已经做好了准备，到时候可以快速迁移到这个角色上——然后就能实时录制动画了！
> *此功能需要UE5.4的Motion trajectory插件
- 新增了从UE5和Mixamo人模到MocapCarrier的重定向器。推荐用这个功能替代自动重定向，因为原来的运动速度不一样，经过调试之后将根骨骼的位移x1.5就好多了。
> 注意，Mixamo下载的动画不带根骨骼，启用根运动会出错。我通过[Mixamo Converter](https://terribilisstudio.fr/?section=MC)对其进行转换，然后重定向。另外Mixamo Converter只认Mixamo网站的标准模型。
- 重命名：`MC玩家摄像机 & MC玩家模式`已更名为`MC第一人称摄像机 & MC第一人称模式`，`飞行模式`已更名为`FPV飞行模式`
- 改进了飞行模式，现在按鼠标左右键可以急刹，上升/下降的速度会随飞行速度而变化。

#### 24w17a
- 一大批MC人模正在接近 —— 借助动作捕捉和游戏模式，减轻k帧的工作量，加快动画制作流程！先来看看目前做好的通用模型吧
- 更新了插件结构，*Blender_export.py* 和新的FBX人模放在*Blender扩展资源* 文件夹下。这些FBX模型具有广泛的兼容性，可以导入Blender、UE、Mixamo（在线动作捕捉素材库）、Cascadeur（AI辅助动画软件，可用于视频动捕）等各种软件。MCprep的*生物模型rigs* 文件夹里已经包含了导入UE5.4并经过优化的模型。
- `MocapCarrier`（简称MC）
  - 最基础的模型，自带Steve的粗胳膊皮肤。
  - 下面的高级人模都设置了骨骼兼容，可以直接使用MocapCarrier的动画，无需重定向。如果要用其他动作捕捉软件，推荐用它作为载体，这就是MocapCarrier名字的由来
- `MC_Slim`  
  - 骨架与MocapCarrier相同，自带Alex的细胳膊皮肤。
- `MC_FaceX`  
  - 在MocapCarrier基础上，添加了脸部骨骼，可单独设置嘴巴、眉毛、左眼、右眼、眼白的材质。
  - 脸部不打算做动捕或者高级绑定了，稍后会制作动画库，准备一些常用素材；也可以自己k帧。
- `MC_Slim_FaceX`  
  - 在MC_Slim基础上，添加了脸部骨骼，可单独设置嘴巴、眉毛、左眼、右眼、眼白的材质。
- `MC_模块化绑定`  
  - 在MocapCarrier基础上，调整了腿部骨骼轴向，配置了UE5.4的模块化绑定功能。
  - 把它拖放到场景中，你会直接进入动画模式，能对各个关节进行k帧，腿部和身体有IK绑定。  
  > 不过...应该没人会在虚幻引擎中手搓动画吧（づ￣3￣）づ 以上人模主打一个动作捕捉工作流程，要k帧也可以去Blender或者Cascadeur，所以就只给MocapCarrier做了模块化绑定，其他的不搞了，展示一下新功能就行。模块化绑定的IK控制器需要很奇特的骨骼朝向，不然会变成小短腿，这个bug修了好久

#### 24w16a
- 更新了两个游戏模式，现在可以像玩MC一样用键盘移动/飞行啦。开启UE5自带的 *Take Recorder* 插件后，还能通过 *镜头试拍录制器* 记录运动轨迹，实时运镜。最简单的使用方法是修改 *世界场景设置* 里的 *游戏模式重载* ，不需要拖放蓝图，直接运行游戏就行。
- `MC第一人称摄像机 & MC第一人称模式`  
  - WASD移动，shift潜行，ctrl加速，空格跳跃
  - 包含自动跳跃、潜行防掉、视野缩放等特性
- `飞行摄像机（Do_a_barrel_roll）& 飞行模式`
  - MC有一个超棒的鞘翅模组叫Do a barrel roll，可以像FPV无人机一样做空中机动，我参考他的按键设置制作了飞行模式（目前是初稿，以后可能有修改）
  - WS前进/后退，AD左右偏航，鼠标左右移动横滚，前后移动俯仰
  - 空格上升，shift下降，ctrl加速前进，z加速后退
- *小故事：我本来没有做炸机的程序，但是撞上东西后自带奇妙效果，还特别好玩 (ﾉ･ω･)ﾉ 应该是弹簧臂组件的特性*

#### 24w15b
- 添加了落叶粒子（niagara）和传送门（立方体渲染目标）的基础模板
- 整理了插件结构，可以拖放到场景中的素材都保存在`MC蓝图资源`文件夹下

#### 24w15a
- 更新了一键附魔功能
- **附魔**  
  `对象`：视口选中项  
  `效果`：将附魔材质添加到选中物体的覆层材质  
  `可选项`：祛魔 - 清除覆层材质  
  - 自定义附魔 [颜色，速度，缩放，透明度] - 添加一个组件，在运行时创建动态材质实例，修改以上参数  
  > · 由于动态材质实例的特性，只有开始游戏和渲染时才能看到效果  
  > · 与植物摇摆一起使用会有穿模bug
  

#### 24w14b
- 更新了插件面板的UI文本绑定，为后续更新和多语言支持带来便利。现在所有名称记录在`语言本地化_language_localization.csv`文件中，可以很方便地编辑，然后导入虚幻引擎变成表格，在插件运行时加载。

#### 24w14a
- 重新整理了插件结构，所有虚幻引擎相关内容都在MCprep文件夹里，丢到工程文件的Content目录下就可以使用了
- 从这个版本起，不需要安装Easy File Dialog作为前置插件了，选择文件夹的功能由TApython提供
- 制作了2个视频渲染预设和1个自定义配置文件，可以通过插件面板修改。我们终于实现了在虚幻引擎中快速导出视频的方法——甚至还能导出HDR视频！先来看看全新的“自定义渲染配置”功能吧
- **预设**（选项框）  
  `对象`：MCprep自定义渲染配置/插件面板细节参数  
  `效果`：选择一个渲染预设，加载到“MCprep自定义渲染配置”和插件面板细节参数  
  `可选项`：(Intel)2K.mp4, (Intel)HDR_2K.mp4, 2K.png, ACES_2K.exr, HDR_2K.exr, VR全景_8K.png
- **初始化视频渲染**  
  `对象`：DefaultEngine.ini  
  `效果`：如果要导出视频，需要进行初始化并重启工程文件（一个工程只需一次初始化）。它会解压ffmpeg压缩包，把ffmpeg.exe的路径添加到项目设置中，并修改一些编码参数
- **打开输出文件夹**  
  `对象`：/Saved/MovieRenders  
  `效果`：打开默认输出文件夹。如果路径名称包含中文等特殊字符，会弹出一个警告。此时你可以渲染图片序列帧，但不能用ffmpeg导出视频！建议使用纯英文路径
- **更新渲染配置**  
  `对象`：MCprep自定义渲染配置  
  `效果`：将细节面板的参数载入到“MCprep自定义渲染配置”中，你可以在渲染时调用它。  
  `可选项`：（可以使用预设或手动修改）
  - 输出图片序列帧格式 [png, jpg, exr]  
  - 分辨率 [1080p, 2K, 4K, VR全景_4K, VR全景_8K]
  - 空间采样数、时间采样数
  - 色彩管理 [普通(sRGB), HDR(Rec2100 PQ), ACEScg]
  - 全景渲染（勾选框）
  - 输出视频（勾选框）
  - 视频编码 [H.264, H.265]
  - 硬件加速 [CPU(慢), Nvidia GPU, Intel GPU, AMD GPU]
  - 色度抽样 [yuv420p, yuv422p, yuv444p, yuv420p10le, yuv422p10le, yuv444p10le]
  - 质量 [低, 中, 高, 极高]
  - 是HDR视频（勾选框）
> 如果不清楚某个选项最好不要动它！错误的搭配会导致视频颜色怪异甚至无法播放，不过windows自带的播放器比较差，yuv444都放不出来(*￣︿￣)。显卡编码比cpu快得多，这两年的intel核显就已经很强了，强烈推荐用显卡。另外把png编码成视频的速度远慢于jpg和exr。

  下面是两个新的视频编码预设
- `Nvidia_2K_mp4`使用2560x1440分辨率，输出png序列帧，通过ffmpeg编码为10bit H265的mp4视频。默认编码器是Nvidia的hevc_nvenc  
  注：把8bit素材编码为10bit视频，实测下来真的能减少色彩断层！
- `Nvidia_HDR_2K_mp4`使用 *HDR_2K_exr* 的预设，通过ffmpeg编码为10bit H265的mp4视频，带Rec2100 PQ静态元数据。默认编码器是Nvidia的hevc_nvenc
- *小故事：我测试插件时使用最高质量视频编码，导出后仍然有色彩断层，这是怎么回事呢...？哦原来我在用笔记本远程连接台式机，网络传输压画质了hhh*

#### 24w13b
- 制作了4个渲染预设和1个OCIO色彩管理文件。（如果电脑能流畅运行，我会优先选择录屏，其次才是渲染。毕竟UE5比起blender最大的优势就是速度快嘛。以下渲染配置都是1个采样，不使用路径追踪，有N卡的用户强烈推荐安装DLSS！）  
- `2K_png`是之前常用的渲染设置，使用2560x1440分辨率并输出png序列帧。若安装了DLSS插件，还会使用DLAA。  
- `ACES_2K_exr`使用2560x1440分辨率和ACEScg色彩变换，输出DWAA压缩的exr序列帧。若安装了DLSS插件，还会使用DLAA。这个需要在达芬奇等专业后期软件里剪辑，可以转换成其他色彩空间。  
- `HDR_2K_exr`使用2560x1440分辨率和Rec2100PQ色彩变换，输出DWAA压缩的exr序列帧。若安装了DLSS插件，还会使用DLAA。这个需要在支持HDR和exr的后期软件里剪辑，比如PR和达芬奇。  
- `VR全景_8K_png`使用7680x3840分辨率，输出png序列帧。必须开启虚幻引擎自带的Movie Render Queue Additional Render Passes插件并关闭项目设置里的自动曝光。若安装了DLSS插件，还会使用DLSS Quality。注意全景图需要很高的分辨率才会看起来清晰，而且尺寸要是2:1。默认设置使用横8纵3的拼接模式，速度超慢还占显存（目测24G都不够用），我试验后改成横5纵3，配合DLSS 16G勉强够用。如果电脑带不动可以降分辨率，但是4K会比8K糊得多。

#### 24w13a
- 在弄坏了两次插件后，我准备定期更新github，既能作为备份也能推进开发。不如...就学mojang一周发一个快照吧
- 添加了Readme简介，记录了0.1 0.2两个分支版本
- 制作了用于附魔的覆层材质和用于动画序列帧的材质函数

### 0.2
- 小插件有图形化界面啦~通过右键运行编辑器工具控件即可调出插件面板。下面是已实现的功能和可选参数
- **准备场景**  
  `对象`：视口选中项/资产文件夹  
  `效果`：批量优化材质、贴图和碰撞箱。修改模型碰撞复杂度为“将复杂碰撞用作简单碰撞”；修改材质混合模式为“已遮罩”，启用“双面”，连接Alpha通道，将高光贴图反转后连接到粗糙度；修改纹理贴图的过滤器为“最近”，如果不是法线贴图再把压缩设置改为“用户界面2D（RGBA）”  
  `可选项`：重载材质属性（金属度，高光度，粗糙度）
  
- **更换材质**  
  `前提`：安装UE5的Easy File Dialog插件  
  `对象`：视口选中项/资产文件夹  
  `效果`：批量更换贴图（支持PBR材质包，但不支持CTM连接纹理），同时调用“准备场景”中的优化材质功能。运行时会弹出资源管理器，让你选择一个MC材质包解压后的文件夹。  
  `可选项`：重载材质属性（金属度，高光度，粗糙度） 

- **植物摇摆**  
  `前提`：安装UE5的TApython插件  
  `对象`：视口选中项/资产文件夹  
  `效果`：让选中的对象随风摇摆。在材质中创建simple grass wind节点并连接到全局位置偏移  
  `可选项`：摇摆幅度，摇摆速度

- **启动Blender**  
  `效果`：把你的Blender.exe文件路径复制到框中（建议直接复制到插件的默认值），点一下图标即可打开blender。以后还会添加更多功能

- *小故事：~~怎么会有人把自己的插件搞坏了两次啊qwq~~ 我想把插件复制到另一个工程文件里，一不小心按了ctrl+x剪贴，又一不小心按了ctrl+z撤销，然后它 ...原地消失了！  
  尝试恢复文件无果后，我只好从头再做一遍，不过这次有了更好看的UI界面和更整齐的蓝图节点，为后续更新打下了基础*


### 0.1
- 最早的版本，写了两个python文件，`Blender_export.py`可以在blender中批量处理mcprep优化过的材质，使贴图能够导出到OBJ/FBX中。`unreal_mcprep.py`则是在虚幻引擎里批量优化材质、贴图和碰撞箱。
- *小故事：当时我随便给文件起了个名字，好像叫test.py，结果一不小心把它覆写掉了，痛失插件qwq。后来我重写了代码，把它传到github上做备份，Unreal MCprep从此诞生了！*
